<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ultimate Home Loan Savings & Prepayment Analyzer</title>
    <!-- SEO Metadata -->
    <meta name="description" content="Advanced home loan EMI calculator and saving analyzer. Calculate monthly payments, analyze prepayments, and see interest savings when reducing tenure or EMI.">
    <meta name="keywords" content="Home Loan Calculator, Advance Home Loan Calculator, Home Loan Calculator with Prepayment, Home Loan Tax Saving Calculator, EMI Calculator, Loan Amortization Schedule, Loan Repayment Analyzer, Prepayment Savings, Reduce Loan Tenure, Reduce Monthly EMI, financial calculator, India loan calculator">
    <meta name="author" content="Loan Analyzer App">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        /* Increased responsiveness for the table container */
        .scrollable-table {
            max-height: 500px;
            overflow-x: auto; /* Allows horizontal scrolling for the wide table on small screens */
            overflow-y: auto;
        }
        /* Fixed width for table content on mobile to prevent stretching */
        .min-w-full {
             min-width: 850px; /* Ensure table columns have space, allowing container to scroll */
        }
        /* Custom Tailwind class for input group */
        .input-group {
            @apply flex rounded-xl shadow-sm;
        }
        .input-unit {
            @apply inline-flex items-center px-3 text-sm text-gray-500 bg-gray-100 border border-l-0 border-gray-300 rounded-r-xl;
        }
        .input-field-group {
            /* Applied to the input inside the group, rounded-l-lg */
            @apply w-full p-3 border border-gray-300 rounded-l-xl focus:ring-teal-500 focus:border-teal-500 transition duration-150;
        }
        .input-field {
             /* Original input-field for select/non-grouped items */
            @apply w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 transition duration-150;
        }
        .table-header {
            @apply px-4 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider bg-indigo-100/50;
        }
        .table-cell {
            @apply px-4 py-3 whitespace-nowrap text-right text-gray-700;
        }
        .table-cell:first-child {
            @apply text-center;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-3xl p-6 lg:p-12 border border-gray-100">
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-indigo-900 mb-8 text-center">
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-teal-500">The Ultimate Home Loan Analyzer</span>
        </h1>

        <!-- Main Input Grid Container -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- Loan Details Card (Col 1) -->
            <div class="lg:col-span-1 p-6 border border-indigo-200 rounded-2xl bg-indigo-50/50 shadow-lg h-full">
                <h2 class="text-2xl font-bold text-indigo-800 mb-6">Loan Details</h2>
                <div id="loan-details-section" class="space-y-4">
                    <!-- Principal Input Group -->
                    <div class="flex flex-col">
                        <label for="principal" class="text-sm font-medium text-gray-700 mb-1">Total Principal</label>
                        <div class="input-group">
                            <input type="number" id="principal" placeholder="50,00,000" value="5000000" class="input-field-group border-r-0" required min="1000">
                            <span class="input-unit border-l-0">₹</span>
                        </div>
                    </div>

                    <!-- Interest Rate Input Group -->
                    <div class="flex flex-col">
                        <label for="rate" class="text-sm font-medium text-gray-700 mb-1">Interest Rate</label>
                        <div class="input-group">
                            <input type="number" id="rate" placeholder="8.5" value="8.5" step="0.01" class="input-field-group border-r-0" required min="0.1" max="50">
                            <span class="input-unit border-l-0">%</span>
                        </div>
                    </div>
                    
                    <!-- Tenure Input Group -->
                    <div class="flex flex-col">
                        <label for="tenure" class="text-sm font-medium text-gray-700 mb-1">Loan Tenure</label>
                        <div class="input-group">
                            <input type="number" id="tenure" placeholder="20" value="20" class="input-field-group border-r-0" required min="1" max="25">
                            <span class="input-unit border-l-0">Years</span>
                        </div>
                    </div>
                    
                    <!-- START MONTH INPUT -->
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700 mb-1">Loan Start Month</label>
                        <div class="flex gap-2">
                            <select id="start-month" class="input-field w-1/2" required></select>
                            <select id="start-year" class="input-field w-1/2" required></select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Repo Rate Change Simulation Card (Col 2 & 3) -->
            <div class="lg:col-span-2 p-6 border border-teal-200 rounded-2xl bg-teal-50/50 shadow-lg">
                <h2 class="text-2xl font-bold text-teal-800 mb-6">Repo Rate Change Simulation (Up to 3)</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    <!-- Rate Change 1 -->
                    <div class="space-y-4 p-4 border border-teal-300 rounded-xl bg-white/50">
                        <h3 class="text-md font-semibold text-teal-700">Change 1</h3>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700 mb-1">Date</label>
                            <div class="flex gap-2">
                                <select id="rate-change-month-1" class="input-field w-1/2"></select>
                                <select id="rate-change-year-1" class="input-field w-1/2"></select>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label for="new-rate-1" class="text-sm font-medium text-gray-700 mb-1">New Rate</label>
                            <div class="input-group">
                                <input type="number" id="new-rate-1" placeholder="e.g., 9.0" step="0.01" class="input-field-group border-r-0" min="0.1" max="50">
                                <span class="input-unit border-l-0">%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Rate Change 2 -->
                    <div class="space-y-4 p-4 border border-teal-300 rounded-xl bg-white/50">
                        <h3 class="text-md font-semibold text-teal-700">Change 2</h3>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700 mb-1">Date</label>
                            <div class="flex gap-2">
                                <select id="rate-change-month-2" class="input-field w-1/2"></select>
                                <select id="rate-change-year-2" class="input-field w-1/2"></select>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label for="new-rate-2" class="text-sm font-medium text-gray-700 mb-1">New Rate</label>
                            <div class="input-group">
                                <input type="number" id="new-rate-2" placeholder="e.g., 7.5" step="0.01" class="input-field-group border-r-0" min="0.1" max="50">
                                <span class="input-unit border-l-0">%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rate Change 3 -->
                    <div class="space-y-4 p-4 border border-teal-300 rounded-xl bg-white/50">
                        <h3 class="text-md font-semibold text-teal-700">Change 3</h3>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700 mb-1">Date</label>
                            <div class="flex gap-2">
                                <select id="rate-change-month-3" class="input-field w-1/2"></select>
                                <select id="rate-change-year-3" class="input-field w-1/2"></select>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label for="new-rate-3" class="text-sm font-medium text-gray-700 mb-1">New Rate</label>
                            <div class="input-group">
                                <input type="number" id="new-rate-3" placeholder="e.g., 8.0" step="0.01" class="input-field-group border-r-0" min="0.1" max="50">
                                <span class="input-unit border-l-0">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="calculateLoan()" id="calculate-btn" class="lg:col-span-3 mt-4 bg-gradient-to-r from-indigo-600 to-teal-500 hover:from-indigo-700 hover:to-teal-600 text-white text-xl font-bold py-4 rounded-xl transition duration-300 shadow-xl hover:shadow-2xl">
                Proceed to Calculation
            </button>
        </div>

        <!-- Results Summary Section -->
        <div id="summary-section" class="hidden mb-8 grid grid-cols-1 sm:grid-cols-3 gap-6 p-6 border border-gray-200 rounded-2xl bg-gray-50 shadow-inner">
            <!-- Initial EMI -->
            <div class="summary-card bg-indigo-50 border-b-4 border-indigo-500 rounded-xl p-5 shadow-md">
                <p class="text-sm font-medium text-indigo-700">Starting EMI</p>
                <p id="initial-emi-output" class="text-3xl font-extrabold text-indigo-900 mt-1"></p>
            </div>
            <!-- Total Interest Payable -->
            <div class="summary-card bg-red-50 border-b-4 border-red-500 rounded-xl p-5 shadow-md">
                <p class="text-sm font-medium text-red-700">Projected Total Interest</p>
                <p id="initial-interest-output" class="text-3xl font-extrabold text-red-900 mt-1"></p>
            </div>
            <!-- Total Loan Duration -->
            <div class="summary-card bg-gray-100 border-b-4 border-gray-400 rounded-xl p-5 shadow-md">
                <p class="text-sm font-medium text-gray-700">Original Duration</p>
                <p id="original-duration-output" class="text-3xl font-extrabold text-gray-900 mt-1"></p>
            </div>
        </div>

        <!-- Prepayment Section -->
        <div id="prepayment-container" class="hidden p-8 border border-green-300 rounded-2xl bg-green-50 shadow-xl mb-8">
            <h2 class="text-3xl font-bold text-green-800 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8v4m0 4v.01M12 18h.01M12 14v.01M16 19a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2h10z" />
                </svg>
                Prepayment Strategy
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Reduction Option -->
                <div class="flex flex-col">
                    <label for="reduction-option" class="block text-sm font-medium text-gray-700 mb-1">1. After Prepayment, Reduce:</label>
                    <select id="reduction-option" class="input-field" onchange="updatePrepaymentOptions()">
                        <option value="tenure">Loan Tenure (Recommended for max savings)</option>
                        <option value="emi">Monthly EMI</option>
                    </select>
                </div>
                
                <!-- Prepayment Frequency -->
                <div class="flex flex-col">
                    <label for="prepayment-type" class="block text-sm font-medium text-gray-700 mb-1">2. Prepayment Frequency</label>
                    <select id="prepayment-type" onchange="updatePrepaymentInputs()" class="input-field">
                        <option value="none">No Prepayment</option>
                        <option value="monthly">Monthly (Regular)</option>
                        <option value="quarterly">Quarterly (Regular)</option>
                        <option value="six-monthly">Six-Monthly (Regular)</option>
                        <option value="yearly">Yearly (Regular)</option>
                        <option value="one-time">One Time Lump Sum</option>
                        <option value="custom">On Particular Months (Custom Schedule)</option>
                    </select>
                </div>
            </div>

            <!-- Prepayment Amount (for regular payments) -->
            <!-- Visible for: monthly, quarterly, six-monthly, yearly -->
            <div id="prepayment-amount-div" class="mb-6 p-4 border border-green-200 rounded-xl bg-green-100/50">
                <label for="prepayment-amount" class="block text-sm font-medium text-gray-700 mb-1">3. Prepayment Amount (in addition to EMI)</label>
                <div class="flex flex-col">
                    <input type="number" id="prepayment-amount" placeholder="Amount (e.g., 50000)" class="input-field" min="0" value="0">
                </div>
            </div>
            
            <!-- NEW: Dedicated One-Time Lump Sum Container -->
            <!-- Visible for: one-time -->
            <div id="one-time-container" class="mb-6 hidden p-6 border border-green-300 rounded-xl bg-green-100 shadow-inner">
                <label class="block text-lg font-bold text-green-800 mb-3">3. One-Time Lump Sum Date & Amount</label>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <select id="one-time-month-input" class="input-field" required></select>
                    <select id="one-time-year-input" class="input-field" required></select>
                    <input type="number" id="one-time-amount" placeholder="Amount" class="input-field" min="1" required>
                </div>
            </div>

            <!-- Custom Month Input (Only shown when 'custom' is selected) -->
            <!-- Visible for: custom -->
            <div id="custom-months-div" class="col-span-1 md:col-span-2 hidden p-6 border border-green-300 rounded-xl bg-green-100 shadow-inner">
                <label class="block text-lg font-bold text-green-800 mb-3">Custom Prepayment Entry</label>
                
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                    <select id="custom-payment-month" class="input-field col-span-1 sm:col-span-1" required></select>
                    <select id="custom-payment-year" class="input-field col-span-1 sm:col-span-1" required></select>
                    <input type="number" id="custom-payment-amount" placeholder="Amount" class="input-field col-span-1 sm:col-span-1" min="1" required>
                    <button onclick="addCustomPayment()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl transition duration-200 shadow-md">
                        Add Payment
                    </button>
                </div>

                <div class="mt-6">
                    <p class="text-sm font-medium text-gray-700 mb-2 border-b border-green-300 pb-1">Current Custom Payments:</p>
                    <div id="custom-payments-list" class="max-h-36 overflow-y-auto space-y-3 p-1">
                        <!-- Payments will be listed here -->
                        <p id="custom-payments-placeholder" class="text-gray-500 text-sm italic">No custom payments added yet.</p>
                    </div>
                </div>
            </div>
            
            <button onclick="applyPrepayments()" class="w-full mt-6 bg-gradient-to-r from-green-600 to-lime-500 hover:from-green-700 hover:to-lime-600 text-white font-bold py-4 rounded-xl transition duration-300 shadow-lg">
                Apply Prepayments & See Savings
            </button>
        </div>

        <!-- Savings Summary Section -->
        <div id="savings-summary" class="hidden mb-8 p-8 border-l-4 border-amber-500 bg-amber-50 rounded-2xl shadow-xl">
            <h2 class="text-3xl font-bold text-amber-800 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.33 0 2.5.895 2.5 2s-1.17 2-2.5 2-2.5.895-2.5 2 1.17 2 2.5 2m0-8v8m0-8h.01M12 21a9 9 0 100-18 9 9 0 000 18z" />
                </svg>
                Prepayment Savings Analysis
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-xl shadow-inner border border-amber-300">
                    <p class="text-sm font-medium text-amber-700">Total Interest Saved</p>
                    <p id="saved-interest-output" class="text-3xl font-extrabold text-amber-900 mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-inner border border-amber-300">
                    <p class="text-sm font-medium text-amber-700">New Loan Duration</p>
                    <p id="new-duration-output" class="text-3xl font-extrabold text-amber-900 mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-inner border border-amber-300">
                    <p class="text-sm font-medium text-amber-700">Reduction in Tenure</p>
                    <p id="tenure-reduction-output" class="text-3xl font-extrabold text-amber-900 mt-1"></p>
                </div>
            </div>
            <div id="new-emi-info" class="mt-6 p-4 bg-amber-100 rounded-xl text-md font-medium text-amber-800 border-l-4 border-amber-600"></div>
        </div>

        <!-- Schedule Section -->
        <div id="schedule-section" class="hidden mt-10">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h2 class="text-3xl font-bold text-indigo-800 mb-3 sm:mb-0">Monthly Repayment Schedule</h2>
                <button onclick="exportTableToCSV('loan_schedule.csv')" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 shadow-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Export to CSV/Excel
                </button>
            </div>
            <div class="scrollable-table shadow-xl rounded-xl border border-gray-200">
                <table class="min-w-full divide-y divide-indigo-200" id="loan-schedule-table">
                    <!-- FIX 1: Added bg-white to thead for proper sticky scrolling -->
                    <thead class="sticky top-0 z-10 bg-white">
                        <tr>
                            <th class="table-header">Month</th>
                            <th class="table-header">Date</th>
                            <th class="table-header">EMI</th>
                            <th class="table-header">Prepayment</th>
                            <th class="table-header">Towards Principal</th>
                            <th class="table-header">Towards Interest</th>
                            <th class="table-header">Outstanding Principal</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body" class="bg-white divide-y divide-gray-100 text-sm">
                        <!-- Schedule rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alert/Error Message Box -->
        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden" onclick="hideMessage()">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full border border-red-200" onclick="event.stopPropagation()">
                <h3 id="message-title" class="text-2xl font-bold mb-4 text-red-600">Error</h3>
                <p id="message-text" class="text-gray-700 mb-6">An error occurred.</p>
                <button onclick="hideMessage()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables for configuration and state
        let initialPrincipal = 0;
        let initialRate = 0; // Annual rate percentage
        let initialTenureMonths = 0;
        let initialEMI = 0;
        let initialTotalInterest = 0;
        let initialTotalPayments = 0;
        let loanStartDateString = ''; // YYYY-MM string for the loan start date
        
        // --- NEW GLOBAL STATE FOR MULTI-RATE CHANGES ---
        let rateChanges = []; // Array of { monthIndex: number, monthlyRate: number, annualRate: number }
        // --- END NEW GLOBAL STATE ---
        
        // Storage for custom prepayments: Array of { monthIndex: number, date: string, amount: number }
        let customPayments = []; 

        // Currency format set to minimumFractionDigits: 0 (nearest Rupee)
        const CURRENCY_FORMAT = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });

        /**
         * Helper function to round monetary values to the nearest whole number (Rupee).
         * This is used in calculations to prevent floating-point errors and keep numbers clean.
         * @param {number} num - The number to round.
         * @returns {number} The rounded number.
         */
        const roundToRupee = (num) => Math.round(num);


        // --- Utility Functions ---

        /**
         * Custom alert box replacement.
         * @param {string} title - Title of the message box.
         * @param {string} message - Content of the message.
         * @param {string} type - 'success', 'error', 'warning' for styling.
         */
        function showMessage(title, message, type = 'error') {
            const box = document.getElementById('message-box');
            const titleEl = document.getElementById('message-title');
            const textEl = document.getElementById('message-text');
            const buttonEl = box.querySelector('button');

            titleEl.textContent = title;
            textEl.textContent = message;

            // Apply colors based on type
            let titleColor = 'text-red-600';
            let buttonColor = 'bg-red-600 hover:bg-red-700';

            if (type === 'success') {
                titleColor = 'text-green-600';
                buttonColor = 'bg-green-600 hover:bg-green-700';
            } else if (type === 'warning') {
                titleColor = 'text-amber-600';
                buttonColor = 'bg-amber-600 hover:bg-amber-700';
            }

            titleEl.className = `text-2xl font-bold mb-4 ${titleColor}`;
            buttonEl.className = `w-full ${buttonColor} text-white font-bold py-3 rounded-xl transition duration-200`;
            
            box.classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        /**
         * Calculates the EMI for a loan.
         * @param {number} P - Principal loan amount.
         * @param {number} r - Monthly interest rate (decimal).
         * @param {number} n - Total number of months.
         * @returns {number} The monthly EMI amount.
         */
        function calculateEMI(P, r, n) {
            if (r === 0) {
                return P / n;
            }
            // EMI = P * [r * (1 + r)^n] / [(1 + r)^n - 1]
            return P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
        }

        /**
         * Converts a prepayment date (YYYY-MM) into a 1-based month index relative to the loan start date.
         * @param {string} dateString - YYYY-MM string of the event.
         * @param {string} loanStartDateString - YYYY-MM string of the loan start.
         * @returns {number} The 1-based month index (e.g., 1 for the first payment month).
         */
        function getMonthIndexFromDate(dateString, loanStartDateString) {
            if (!dateString) return 9999;
            const [pYear, pMonth] = dateString.split('-').map(Number);
            const [sYear, sMonth] = loanStartDateString.split('-').map(Number);
            
            // Months elapsed since loan start (0-based)
            const monthsElapsed = (pYear - sYear) * 12 + (pMonth - sMonth);
            
            // Month index is 1-based
            return monthsElapsed + 1;
        }

        /**
         * Gets the date for a given month index in the loan.
         * @param {number} monthIndex - 1-based index (1 for the first payment).
         * @param {string} startDateString - YYYY-MM string from the input.
         * @returns {string} Formatted date string (e.g., "Oct 2025").
         */
        function getDateForMonth(monthIndex, startDateString) {
            const [yearStr, monthStr] = startDateString.split('-');
            let startYear = parseInt(yearStr);
            let startMonth = parseInt(monthStr); // 1-12

            // Calculate the target month and year
            let targetMonth = startMonth + monthIndex - 1;
            let targetYear = startYear + Math.floor((targetMonth - 1) / 12);
            targetMonth = ((targetMonth - 1) % 12) + 1; // Normalize to 1-12

            const date = new Date(targetYear, targetMonth - 1);
            return date.toLocaleString('en-US', { month: 'short', year: 'numeric' });
        }
        
        /**
         * Converts the HTML table data into a CSV string and downloads it.
         * @param {string} filename - The name for the downloaded file.
         */
        function exportTableToCSV(filename) {
            const table = document.getElementById('loan-schedule-table');
            if (!table) {
                showMessage('Export Error', 'Loan schedule table not found.', 'error');
                return;
            }

            const rows = table.querySelectorAll('tr');
            let csv = [];

            // 1. Get Table Headers (Thead)
            const headerCells = table.querySelectorAll('thead th');
            const header = Array.from(headerCells).map(th => `"${th.textContent.trim()}"`).join(',');
            csv.push(header);

            // 2. Get Table Body Rows (Tbody)
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                const rowData = [];
                // Get all cells (td) in the row
                const cells = row.querySelectorAll('td');

                cells.forEach(cell => {
                    // Extract text content, remove non-numeric characters (like ₹ or ,) 
                    // and handle special indicators like "(New)" and Rate change indicators for clean numbers
                    let content = cell.textContent.trim();
                    
                    // Remove currency symbols, commas, and formatting tags
                    content = content.replace(/₹/g, '').replace(/,/g, '').replace(/\(New\)/g, '').replace(/\(Rate: [0-9.]+%\)/g, '').trim();

                    // Replace non-breaking spaces if any
                    content = content.replace(/\s+/g, ' '); 
                    
                    // Enclose content in quotes to handle dates/text fields
                    rowData.push(`"${content}"`);
                });
                csv.push(rowData.join(','));
            });

            // If no data was exported (only headers), throw a warning
            if (csv.length <= 1) {
                 showMessage('Export Warning', 'The loan schedule is empty. Please calculate the loan first before exporting.', 'warning');
                 return;
            }

            // 3. Create Blob and Trigger Download
            const csvFile = csv.join('\n');
            const blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
            
            // Use a temporary anchor element to trigger the download
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        /**
         * Helper function to get the current YYYY-MM string from the Loan Start Month selects.
         */
        function getLoanStartDateString() {
            const month = document.getElementById('start-month').value;
            const year = document.getElementById('start-year').value;
            if (month && year) {
                return `${year}-${month}`;
            }
            return null;
        }

        // --- Core Calculation Logic ---

        /**
         * Generates the amortization schedule up to a maximum number of payments (months).
         * @param {number} principal - Starting principal.
         * @param {number} initialMonthlyRate - Starting monthly rate.
         * @param {number} emi - The fixed EMI amount to use in the schedule.
         * @param {number} maxMonths - The maximum number of months to run the schedule.
         * @param {Object} prepayments - Map of { monthIndex: amount }.
         * @param {Array} rateChanges - Array of rate change objects.
         */
        function generateAmortizationSchedule(principal, initialMonthlyRate, emi, maxMonths, prepayments = {}, rateChanges = []) {
            let outstanding = principal;
            let totalInterest = 0;
            let totalPayments = 0;
            let schedule = [];
            let currentMonthlyRate = initialMonthlyRate;
            let currentAnnualRate = initialMonthlyRate * 12 * 100;

            // Sort rate changes by monthIndex for deterministic processing
            rateChanges.sort((a, b) => a.monthIndex - b.monthIndex);
            let nextRateChangeIndex = 0;


            for (let monthIndex = 1; monthIndex <= maxMonths; monthIndex++) {
                if (outstanding <= 0) break;

                // --- MULTI-RATE CHANGE LOGIC ---
                while (nextRateChangeIndex < rateChanges.length && monthIndex === rateChanges[nextRateChangeIndex].monthIndex) {
                    currentMonthlyRate = rateChanges[nextRateChangeIndex].monthlyRate;
                    currentAnnualRate = rateChanges[nextRateChangeIndex].annualRate;
                    nextRateChangeIndex++;
                }
                // --- END MULTI-RATE CHANGE LOGIC ---
                
                // 1. Calculate Interest for the month and round it to the nearest rupee
                let interest = outstanding * currentMonthlyRate;
                interest = roundToRupee(interest);

                // 2. Determine Prepayment amount
                const prepayment = prepayments[monthIndex] || 0;

                // 3. Determine total payment (EMI + Prepayment)
                let payment = emi + prepayment;

                // If remaining outstanding is less than (EMI + interest), final payment is capped
                let principalPaid, interestPaid, outstandingEnd;
                
                if (outstanding + interest <= payment) {
                    payment = outstanding + interest;
                    principalPaid = outstanding; 
                    interestPaid = interest; 
                    outstandingEnd = 0;
                } else {
                    interestPaid = interest;
                    principalPaid = payment - interest;
                    outstandingEnd = outstanding - principalPaid;
                }
                
                // If principalPaid becomes negative, adjust for safety (shouldn't happen with correct EMI)
                if (principalPaid < 0) {
                    principalPaid = 0;
                    outstandingEnd = outstanding;
                    if (emi < interest && principal > 0) { // Only show error if loan hasn't paid off
                        showMessage('Loan Calculation Error', `The calculated EMI (${CURRENCY_FORMAT.format(emi)}) is less than the current month's interest (${CURRENCY_FORMAT.format(interest)}). Please check your Rate or Principal.`);
                        return { schedule: [], totalInterest: 0, totalPayments: 0 };
                    }
                }

                // Final rounding of the monthly principal and new outstanding balance
                principalPaid = roundToRupee(principalPaid);
                // Ensure outstanding end calculation uses the rounded principal paid
                outstandingEnd = roundToRupee(outstanding - principalPaid); 
                
                // Handle the case where the rounding caused a slight overshoot/undershoot on the final payment
                if (outstandingEnd < 0) outstandingEnd = 0;


                schedule.push({
                    month: monthIndex,
                    emi: emi,
                    prepayment: prepayment,
                    principal: principalPaid,
                    interest: interestPaid,
                    outstanding: outstandingEnd,
                    isPrepaymentMonth: prepayment > 0,
                    // Track rate for display purposes
                    rate: currentAnnualRate
                });

                totalInterest += interestPaid;
                totalPayments = monthIndex;
                outstanding = outstandingEnd;

                // If the loan is paid off, stop.
                if (outstandingEnd <= 0) break;
            }

            // Round final total interest for cleaner output
            totalInterest = roundToRupee(totalInterest);

            return { schedule, totalInterest, totalPayments };
        }

        // --- UI Event Handlers (Prepayment) ---

        /**
         * Dynamically updates the available prepayment types based on the selected reduction option.
         */
        function updatePrepaymentOptions() {
            const reductionOption = document.getElementById('reduction-option').value;
            const prepaymentSelect = document.getElementById('prepayment-type');
            
            // These options are disabled/hidden for EMI reduction, as they usually reduce tenure by default
            const periodicOptions = ['monthly', 'quarterly', 'six-monthly', 'yearly'];

            let shouldResetSelection = false;
            const currentSelection = prepaymentSelect.value;

            prepaymentSelect.querySelectorAll('option').forEach(option => {
                const isPeriodic = periodicOptions.includes(option.value);

                if (reductionOption === 'emi') {
                    // In EMI reduction mode, disable periodic options
                    if (isPeriodic) {
                        option.disabled = true;
                        option.hidden = true;
                        if (option.value === currentSelection) {
                            shouldResetSelection = true;
                        }
                    } else {
                        option.disabled = false;
                        option.hidden = false;
                    }
                } else {
                    // In Tenure reduction mode, enable all options
                    option.disabled = false;
                    option.hidden = false;
                }
            });

            if (shouldResetSelection) {
                // If a newly disabled option was selected, fall back to "none"
                prepaymentSelect.value = 'none';
            }
            // Always call updatePrepaymentInputs to ensure the amount/custom inputs reflect the final selection
            updatePrepaymentInputs(); 
        }

        /**
         * FIX 2: Update to manage visibility for recurring, one-time, and custom.
         */
        function updatePrepaymentInputs() {
            const type = document.getElementById('prepayment-type').value;
            const recurringDiv = document.getElementById('prepayment-amount-div');
            const oneTimeDiv = document.getElementById('one-time-container'); // NEW
            const customDiv = document.getElementById('custom-months-div');

            // 1. Recurring Payments (Monthly, Yearly, etc.)
            const isRecurring = ['monthly', 'quarterly', 'six-monthly', 'yearly'].includes(type);
            recurringDiv.classList.toggle('hidden', !isRecurring);

            // 2. One Time Lump Sum (FIX 2)
            const isOneTime = (type === 'one-time');
            oneTimeDiv.classList.toggle('hidden', !isOneTime);
            
            if (isOneTime) {
                 // Ensure date selectors are populated on load/switch
                 const monthInput = document.getElementById('one-time-month-input');
                 const yearInput = document.getElementById('one-time-year-input');

                 if (monthInput.options.length <= 1) { // Check if not populated (only contains placeholder)
                    populateMonthYearSelects(monthInput, yearInput);
                 }

                 // Set default date for one-time payment to loan start date if available
                 if (loanStartDateString) {
                     const [year, month] = loanStartDateString.split('-');
                     monthInput.value = month;
                     yearInput.value = year;
                 }
            }


            // 3. Custom Schedule
            const isCustom = (type === 'custom');
            customDiv.classList.toggle('hidden', !isCustom);
        }
        
        /**
         * Manages the visibility of the one-time date selectors within the amount div.
         * (This function is now obsolete after the refactor to use #one-time-container, 
         * but kept for reference and safety if called externally, though it should be removed 
         * in a final production version. For now, it's bypassed by the refactor.)
         */
        // function showOneTimeDateSelectors(show) { ... } // Removed redundant function


        /**
         * Helper function to get the current YYYY-MM string from the Custom Prepayment selects.
         */
        function getCustomPaymentDateString() {
            const month = document.getElementById('custom-payment-month').value;
            const year = document.getElementById('custom-payment-year').value;
            if (month && year) {
                return `${year}-${month}`;
            }
            return null;
        }

        /**
         * Adds a custom prepayment (date + amount) to the global list.
         */
        function addCustomPayment() {
            const prepaymentDateString = getCustomPaymentDateString();
            const prepaymentAmount = parseFloat(document.getElementById('custom-payment-amount').value);
            
            if (!loanStartDateString) {
                showMessage('Error', 'Please calculate the initial loan first to set the loan start date.', 'error');
                return;
            }

            if (!prepaymentDateString || !prepaymentAmount || prepaymentAmount <= 0 || isNaN(prepaymentAmount)) {
                showMessage('Missing Data', 'Please select a Month/Year and enter a valid positive Amount.', 'error');
                return;
            }
            
            const monthIndex = getMonthIndexFromDate(prepaymentDateString, loanStartDateString);
            
            if (monthIndex < 1) {
                showMessage('Date Error', 'The prepayment date must be in or after the loan start month (' + getDateForMonth(1, loanStartDateString) + ').', 'error');
                return;
            }
            
            // Max month index is based on 25 years (300 months)
            if (monthIndex > 300) {
                 showMessage('Date Warning', 'The selected month is beyond the maximum 25-year tenure (300 months) typically supported. It will be ignored if the loan is paid off before then.', 'warning');
            }


            // Add or merge the payment
            const existingPaymentIndex = customPayments.findIndex(p => p.monthIndex === monthIndex);

            if (existingPaymentIndex !== -1) {
                customPayments[existingPaymentIndex].amount += roundToRupee(prepaymentAmount); // Round input on merge
            } else {
                customPayments.push({
                    monthIndex: monthIndex,
                    date: prepaymentDateString, // Store as YYYY-MM
                    amount: roundToRupee(prepaymentAmount), // Round input on creation
                });
                // Sort by month index to ensure easy review
                customPayments.sort((a, b) => a.monthIndex - b.monthIndex);
            }
            
            // Clear inputs and refresh list
            document.getElementById('custom-payment-amount').value = '';
            renderCustomPaymentsList();
        }

        /**
         * Removes a custom prepayment from the list.
         * @param {number} monthIndex - The 1-based month index of the payment to remove.
         */
        function removeCustomPayment(monthIndex) {
            customPayments = customPayments.filter(p => p.monthIndex !== monthIndex);
            renderCustomPaymentsList();
        }

        /**
         * Renders the list of custom payments in the UI.
         */
        function renderCustomPaymentsList() {
            const listEl = document.getElementById('custom-payments-list');
            listEl.innerHTML = '';

            if (customPayments.length === 0) {
                listEl.innerHTML = '<p id="custom-payments-placeholder" class="text-gray-500 text-sm italic">No custom payments added yet.</p>';
                return;
            }

            customPayments.forEach(p => {
                const dateDisplay = getDateForMonth(p.monthIndex, loanStartDateString);

                const item = document.createElement('div');
                // Alternating row colors for better readability
                item.className = 'flex justify-between items-center p-3 bg-white hover:bg-green-50 rounded-lg shadow-sm border border-gray-200 transition duration-150';
                item.innerHTML = `
                    <span class="text-sm font-medium text-gray-800">${dateDisplay} (Month ${p.monthIndex}):</span>
                    <span class="text-sm font-bold text-green-700">${CURRENCY_FORMAT.format(p.amount)}</span>
                    <button onclick="removeCustomPayment(${p.monthIndex})" class="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listEl.appendChild(item);
            });
        }


        /**
         * Finds the applicable monthly rate for a given month index, considering all defined rate changes.
         * @param {number} monthIndex - The 1-based month index.
         * @returns {number} The current monthly rate (decimal).
         */
        function getCurrentMonthlyRate(monthIndex) {
            let currentRate = (initialRate / 100) / 12; // Start with initial rate

            // Iterate through sorted rate changes
            for (const change of rateChanges) {
                if (change.monthIndex <= monthIndex) {
                    currentRate = change.monthlyRate;
                } else {
                    // Since rateChanges is sorted, we can stop early
                    break; 
                }
            }
            return currentRate;
        }

        /**
         * Primary function to calculate the initial loan and display the schedule.
         * FIX: Now processes multiple rate changes.
         */
        function calculateLoan() {
            const principal = parseFloat(document.getElementById('principal').value);
            const ratePercent = parseFloat(document.getElementById('rate').value);
            const tenureYears = parseFloat(document.getElementById('tenure').value);
            const startDateString = getLoanStartDateString(); // Get YYYY-MM string from selects
            
            // --- RESET PREPAYMENT & RATE CHANGE STATE ---
            document.getElementById('prepayment-type').value = 'none';
            document.getElementById('prepayment-amount').value = '0';
            document.getElementById('one-time-amount').value = ''; // Reset new one-time amount input
            customPayments = []; // Clear custom payments array
            rateChanges = []; // Clear rate changes array
            renderCustomPaymentsList(); // Clear UI list
            updatePrepaymentOptions(); // Reset UI visibility (calls updatePrepaymentInputs)
            // ------------------------------------------

            const initialMonthlyRate = (ratePercent / 100) / 12;
            const tenureMonths = Math.round(tenureYears * 12);
            const maxMonths = 300; 

            // 1. Validate and Collect Multi-Rate Changes
            for (let i = 1; i <= 3; i++) {
                const monthSelect = document.getElementById(`rate-change-month-${i}`);
                const yearSelect = document.getElementById(`rate-change-year-${i}`);
                const newRateInput = document.getElementById(`new-rate-${i}`);
                
                const rateChangeDateString = monthSelect.value && yearSelect.value ? 
                                             `${yearSelect.value}-${monthSelect.value}` : null;
                const newRate = parseFloat(newRateInput.value);

                if (rateChangeDateString && newRateInput.value !== '') { // Check if rate is intended to be set
                    if (isNaN(newRate) || newRate <= 0) {
                         showMessage('Rate Change Error', `New Rate for Change ${i} is invalid. Must be a positive number.`, 'error');
                         return;
                    }

                    const monthIndex = getMonthIndexFromDate(rateChangeDateString, startDateString);
                    
                    if (monthIndex < 1 || monthIndex > tenureYears * 12) {
                        showMessage('Rate Change Error', `Rate Change ${i} Date (${getDateForMonth(monthIndex, startDateString)}) must be between the first month and the loan's original end month.`, 'error');
                        return;
                    }
                    
                    rateChanges.push({
                        monthIndex: monthIndex,
                        monthlyRate: (newRate / 100) / 12,
                        annualRate: newRate
                    });
                } else if (newRateInput.value !== '' || monthSelect.value !== '' || yearSelect.value !== '') {
                    // Partial input error if any field is filled but not all three required for a change
                     showMessage('Rate Change Error', `Incomplete Rate Change ${i} data. Please ensure you provide the Date (Month/Year) and the New Rate, or leave all fields blank.`, 'error');
                    return;
                }
            }


            // Input Validation (Standard)
            if (!principal || !ratePercent || !tenureYears || !startDateString) {
                showMessage('Missing Information', 'Please fill in the Principal, Interest Rate, Tenure, and Loan Start Month/Year.', 'error');
                return;
            }
            if (tenureYears > 25) {
                showMessage('Maximum Tenure Exceeded', 'The maximum supported loan tenure is 25 years.', 'warning');
                return;
            }

            // Store initial values globally
            initialPrincipal = principal;
            initialRate = ratePercent;
            initialTenureMonths = tenureMonths;
            loanStartDateString = startDateString; // Store the start date

            // Calculate Initial EMI (P, r, n) based on the INITIAL rate and ORIGINAL term
            const rawEmi = calculateEMI(principal, initialMonthlyRate, tenureMonths);
            const emi = roundToRupee(rawEmi);
            initialEMI = emi;

            // Generate the baseline schedule (NO prepayments, but WITH rate changes)
            const result = generateAmortizationSchedule(
                principal, 
                initialMonthlyRate, 
                emi, 
                maxMonths, 
                {}, // No prepayments
                rateChanges // Pass global rate changes
            );
            
            // Check for calculation errors
            if (result.schedule.length === 0 && principal > 0) return; 

            initialTotalInterest = result.totalInterest;
            initialTotalPayments = result.totalPayments;

            // Display Summary
            document.getElementById('initial-emi-output').textContent = CURRENCY_FORMAT.format(emi);
            document.getElementById('initial-interest-output').textContent = CURRENCY_FORMAT.format(initialTotalInterest);
            document.getElementById('original-duration-output').textContent = `${tenureYears} Years (${initialTotalPayments} Months)`;
            
            document.getElementById('summary-section').classList.remove('hidden');
            document.getElementById('prepayment-container').classList.remove('hidden');
            document.getElementById('schedule-section').classList.remove('hidden');
            document.getElementById('savings-summary').classList.add('hidden'); // Hide savings initially
            
            // Render the initial schedule
            renderSchedule(result.schedule, startDateString);

            // Update custom payment list placeholder after loan is calculated
            if (customPayments.length === 0) {
                 document.getElementById('custom-payments-placeholder').textContent = 'No custom payments added yet.';
            }
        }

        /**
         * Handles the prepayment input, recalculates the loan, and updates the display.
         */
        function applyPrepayments() {
            const initialMonthlyRate = (initialRate / 100) / 12;
            const prepaymentType = document.getElementById('prepayment-type').value;
            const reductionOption = document.getElementById('reduction-option').value;
            const startDateString = loanStartDateString; // Use the stored start date
            const maxMonths = 300 * 3; // A sufficiently high number of months

            if (!startDateString || initialPrincipal === 0) {
                 showMessage('Missing Data', 'Please click "Proceed" first to calculate the initial loan details.', 'error');
                 return;
            }


            // 1. Parse Prepayments Map
            let prepaymentsMap = {};
            let prepaymentAmount = 0;
            let totalPrepaymentAmount = 0;

            if (prepaymentType === 'custom') {
                if (customPayments.length === 0) {
                     showMessage('Prepayment Error', 'Please add custom prepayments using the date and amount fields above.', 'error');
                     return;
                }
                customPayments.forEach(p => {
                    prepaymentsMap[p.monthIndex] = (prepaymentsMap[p.monthIndex] || 0) + p.amount;
                });
            } else if (prepaymentType === 'one-time') { // FIX 2: Check for one-time
                const amountInput = document.getElementById('one-time-amount');
                prepaymentAmount = parseFloat(amountInput.value);

                if (prepaymentAmount <= 0 || isNaN(prepaymentAmount)) {
                    showMessage('Prepayment Error', 'Please enter a valid positive amount for the One-Time Lump Sum.', 'error');
                    return;
                }
                prepaymentAmount = roundToRupee(prepaymentAmount);

                const monthInput = document.getElementById('one-time-month-input');
                const yearInput = document.getElementById('one-time-year-input');
                
                if (!monthInput.value || !yearInput.value) {
                    showMessage('Prepayment Error', 'Please select a Month and Year for the One-Time Lump Sum.', 'error');
                    return;
                }

                const oneTimeDate = `${yearInput.value}-${monthInput.value}`;
                const oneTimeMonth = getMonthIndexFromDate(oneTimeDate, loanStartDateString);
                
                if (oneTimeMonth < 1) {
                    showMessage('Date Error', 'The one-time payment date must be in or after the loan start month.', 'error');
                    return;
                }
                prepaymentsMap[oneTimeMonth] = prepaymentAmount;

            } else if (prepaymentType !== 'none') { // Recurring Payments
                prepaymentAmount = parseFloat(document.getElementById('prepayment-amount').value);
                
                if (prepaymentAmount <= 0 || isNaN(prepaymentAmount)) {
                    showMessage('Prepayment Error', `Please enter a valid positive amount for ${prepaymentType} prepayment.`, 'error');
                    return;
                }
                // Round input amount before using it for calculation
                prepaymentAmount = roundToRupee(prepaymentAmount);

                const interval = {
                    'monthly': 1, 'quarterly': 3, 'six-monthly': 6, 'yearly': 12
                }[prepaymentType];
                
                if (interval) {
                    for (let i = interval; i <= initialTenureMonths; i += interval) {
                        prepaymentsMap[i] = prepaymentAmount;
                    }
                }
            }

            if (Object.keys(prepaymentsMap).length === 0) {
                calculateLoan(); 
                return;
            }

            // 2. Initial Run with Prepayments (Tenure Reduction Basis)
            const initialPrepaymentRun = generateAmortizationSchedule(
                initialPrincipal, 
                initialMonthlyRate, 
                initialEMI, 
                maxMonths, 
                prepaymentsMap, 
                rateChanges 
            );
            
            if (initialPrepaymentRun.schedule.length === 0 && initialPrincipal > 0) return;

            totalPrepaymentAmount = initialPrepaymentRun.schedule.reduce((sum, item) => sum + item.prepayment, 0);

            let newEMI = initialEMI;
            let newResult;
            let newEmiInfoText = '';
            let M_recalc = 9999; 

            
            // 3. Recalculation based on Reduction Option
            if (reductionOption === 'tenure') {
                newResult = initialPrepaymentRun;
                newEMI = initialEMI; 
                newEmiInfoText = `Your Monthly EMI remained at ${CURRENCY_FORMAT.format(initialEMI)}.`;
                
            } else if (reductionOption === 'emi') {
                
                // 3a. Determine Recalculation Month (M_recalc) - Month AFTER last prepayment
                let lastPrepaymentMonth = 0;
                if (Object.keys(prepaymentsMap).length > 0) {
                    lastPrepaymentMonth = Math.max(...Object.keys(prepaymentsMap).map(Number));
                }
                M_recalc = lastPrepaymentMonth > 0 ? lastPrepaymentMonth + 1 : 1;
                
                // 3b. Determine Outstanding Principal (pRecalc)
                const lastProcessedMonthIndex = M_recalc - 1;
                let pRecalc = initialPrincipal; 
                
                const lastProcessedEntry = initialPrepaymentRun.schedule.find(item => item.month === lastProcessedMonthIndex);
                
                if (lastProcessedEntry) {
                    pRecalc = lastProcessedEntry.outstanding;
                } else if (lastProcessedMonthIndex > 0 && initialPrepaymentRun.schedule.length > 0) {
                    pRecalc = initialPrepaymentRun.schedule[initialPrepaymentRun.schedule.length - 1].outstanding;
                }
                
                // Determine the interest rate that applies FROM M_recalc onward
                const rateForRecalc = getCurrentMonthlyRate(M_recalc);
                
                // Check if loan is already paid off
                if (pRecalc <= 0) {
                    newEMI = 0;
                    newResult = initialPrepaymentRun;
                    const lastPaidMonth = initialPrepaymentRun.schedule.length;
                    newEmiInfoText = `The loan was paid off early in month ${lastPaidMonth} even with the original EMI. New EMI is not applicable.`;
                    
                } else {

                    // 3c. Calculate New EMI
                    const N_remaining = initialTotalPayments - lastProcessedMonthIndex; // Remaining months based on ORIGINAL tenure

                    if (N_remaining > 0) {
                        // Calculate New EMI based on the reduced principal over the *original remaining tenure* at the * applicable rate*.
                        const rawNewEmi = calculateEMI(pRecalc, rateForRecalc, N_remaining);
                        newEMI = roundToRupee(rawNewEmi);
                    } else {
                        newEMI = 0;
                    }
                    
                    // 3d. Create the Final Schedule for EMI Reduction
                    let schedulePart1 = initialPrepaymentRun.schedule.filter(item => item.month < M_recalc);
                    
                    const remainingPrepayments = {};
                    for (const monthIndex in prepaymentsMap) {
                        if (Number(monthIndex) >= M_recalc) {
                            remainingPrepayments[monthIndex] = prepaymentsMap[monthIndex];
                        }
                    }
                    
                    const maxMonthsPart2 = N_remaining;
                    
                    // Filter rate changes for Part 2 and adjust month indices
                    const part2RateChanges = rateChanges.filter(c => c.monthIndex >= M_recalc)
                                                      .map(c => ({...c, monthIndex: c.monthIndex - lastProcessedMonthIndex}));

                    
                    const resultPart2 = generateAmortizationSchedule(
                        pRecalc, 
                        rateForRecalc, // Starting rate for Part 2
                        newEMI, 
                        maxMonthsPart2, 
                        remainingPrepayments,
                        part2RateChanges
                    );
                    
                    const schedulePart2 = resultPart2.schedule.map(item => ({
                        ...item,
                        month: item.month + lastProcessedMonthIndex,
                        emi: newEMI 
                    }));

                    // 3e. Combine Results
                    let combinedSchedule = [...schedulePart1, ...schedulePart2];
                    
                    // Fill zero-payment rows until the original end date is reached
                    const finalMonthOfOriginalLoan = initialTotalPayments;
                    let lastMonthInCombined = combinedSchedule.length;
                    
                    while (lastMonthInCombined < finalMonthOfOriginalLoan) {
                        lastMonthInCombined++;
                        combinedSchedule.push({
                            month: lastMonthInCombined, emi: newEMI, prepayment: 0, principal: 0, interest: 0, outstanding: 0, isPrepaymentMonth: false,
                        });
                    }

                    const combinedTotalInterest = combinedSchedule.reduce((sum, item) => sum + item.interest, 0);


                    newResult = {
                        schedule: combinedSchedule,
                        totalInterest: combinedTotalInterest, 
                        totalPayments: combinedSchedule.length
                    };

                    // Final info text with Month and Year
                    if (newEMI > 0) {
                        const recalcDateDisplay = getDateForMonth(M_recalc, loanStartDateString);
                        newEmiInfoText = `Your new Monthly EMI will be ${CURRENCY_FORMAT.format(newEMI)} starting from ${recalcDateDisplay} of the loan.`;
                        
                        if (resultPart2.schedule.length < maxMonthsPart2) {
                            const actualPaidOffMonth = schedulePart1.length + resultPart2.schedule.length;
                            newEmiInfoText += ` Note: The loan was physically paid off early in month ${actualPaidOffMonth}. EMI payments stop then.`;
                        }
                    } else {
                        newEmiInfoText = `The loan was paid off early in month ${schedulePart1.length} even with the original EMI.`;
                    }
                }

            } // End of reductionOption === 'emi'

            // 4. Calculate Final Savings
            const newTotalInterest = newResult.totalInterest;
            const interestSaved = initialTotalInterest - newTotalInterest;
            
            const actualPaymentCount = newResult.schedule.filter(item => item.principal > 0 || item.interest > 0 || item.prepayment > 0).length;
            
            const totalPaymentsToDisplay = reductionOption === 'emi' ? initialTotalPayments : newResult.totalPayments;
            
            const tenureReductionMonths = initialTotalPayments - actualPaymentCount;

            // 5. Display Savings Summary
            document.getElementById('saved-interest-output').textContent = CURRENCY_FORMAT.format(interestSaved);
            document.getElementById('new-duration-output').textContent = `${Math.floor(totalPaymentsToDisplay / 12)}Y ${totalPaymentsToDisplay % 12}M (${totalPaymentsToDisplay} Months)`;
            
            const tenureReductionText = reductionOption === 'emi' ? 
                `${Math.floor(tenureReductionMonths / 12)}Y ${tenureReductionMonths % 12}M (Actual Savings)` :
                `${Math.floor(tenureReductionMonths / 12)}Y ${tenureReductionMonths % 12}M`;

            document.getElementById('tenure-reduction-output').textContent = tenureReductionText;
            
            newEmiInfoText += ` Total Prepayment made: ${CURRENCY_FORMAT.format(totalPrepaymentAmount)}.`;
            document.getElementById('new-emi-info').innerHTML = newEmiInfoText;


            document.getElementById('savings-summary').classList.remove('hidden');

            // 6. Render the Final Schedule
            renderSchedule(newResult.schedule, startDateString, newEMI, M_recalc);
        }
        
        /**
         * Renders the amortization schedule table.
         */
        function renderSchedule(schedule, startDateString, currentEMI = initialEMI, recalcMonth = 9999) {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';
            
            const initialEMIValue = initialEMI;
            let currentRateChangeIndex = 0;
            const sortedRateChanges = [...rateChanges].sort((a, b) => a.monthIndex - b.monthIndex);

            schedule.forEach(item => {
                const row = tbody.insertRow();
                
                // Determine rate change indicator for this month
                let isRateChangeMonth = false;
                if (currentRateChangeIndex < sortedRateChanges.length && sortedRateChanges[currentRateChangeIndex].monthIndex === item.month) {
                    isRateChangeMonth = true;
                    currentRateChangeIndex++;
                }
                
                let displayEMI = item.emi;
                
                // Determine the EMI to display (0 if paid off, new EMI if post-recalc)
                if (item.outstanding <= 0 && item.month === schedule.length) {
                     displayEMI = item.principal + item.interest + item.prepayment;
                } else if (item.outstanding <= 0 && item.month < schedule.length) {
                    displayEMI = 0;
                } else if (item.month >= recalcMonth) {
                    displayEMI = currentEMI;
                } else {
                    displayEMI = initialEMIValue;
                }
                
                const rateChangeIndicator = isRateChangeMonth ? 
                    `<span class="text-xs font-semibold text-purple-700 block">(Rate: ${item.rate.toFixed(2)}%)</span>` : '';

                const emiFormat = (value) => {
                    const formatted = CURRENCY_FORMAT.format(value);
                    
                    // EMI change indicator (only show for the specific recalc month)
                    if (item.month === recalcMonth && Math.abs(currentEMI - initialEMIValue) > 1 && value > 0) {
                        return `<span class="font-bold text-red-600">${formatted} (New)</span>`;
                    }
                    
                    return formatted;
                };
                
                // Apply styling
                if (item.outstanding <= 0 && item.month === schedule.length) {
                    row.classList.add('bg-green-100', 'font-bold');
                } else if (item.isPrepaymentMonth) {
                    row.classList.add('bg-yellow-50');
                } else if (isRateChangeMonth) {
                     row.classList.add('bg-purple-50'); // Highlight rate change months
                } else if (item.month % 2 === 0) {
                     row.classList.add('bg-gray-50'); // Zebra striping
                }


                row.innerHTML = `
                    <td class="table-cell font-medium">${item.month}</td>
                    <td class="table-cell whitespace-nowrap text-left">${getDateForMonth(item.month, startDateString)} ${rateChangeIndicator}</td>
                    <td class="table-cell">${emiFormat(displayEMI)}</td>
                    <td class="table-cell ${item.prepayment > 0 ? 'font-bold text-teal-600' : 'text-gray-400'}">${CURRENCY_FORMAT.format(item.prepayment)}</td>
                    <td class="table-cell text-indigo-700">${CURRENCY_FORMAT.format(item.principal)}</td>
                    <td class="table-cell text-red-700">${CURRENCY_FORMAT.format(item.interest)}</td>
                    <td class="table-cell ${item.outstanding <= 0 ? 'text-green-700 font-extrabold' : ''}">${CURRENCY_FORMAT.format(item.outstanding)}</td>
                `;
            });
        }
        
        /**
         * Populates the month and year select inputs.
         * @param {HTMLElement} monthSelect - The month select element.
         * @param {HTMLElement} yearSelect - The year select element.
         */
        function populateMonthYearSelects(monthSelect, yearSelect) {
            const months = [
                { value: '01', name: 'Jan' }, { value: '02', name: 'Feb' }, { value: '03', name: 'Mar' },
                { value: '04', name: 'Apr' }, { value: '05', name: 'May' }, { value: '06', name: 'Jun' },
                { value: '07', name: 'Jul' }, { value: '08', name: 'Aug' }, { value: '09', name: 'Sep' },
                { value: '10', name: 'Oct' }, { value: '11', name: 'Nov' }, { value: '12', name: 'Dec' }
            ];

            // Clear existing options
            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            
            // Add a default blank/placeholder option for Rate Change selects
            if (monthSelect.id.startsWith('rate-change')) {
                monthSelect.insertAdjacentHTML('beforeend', '<option value="" selected>Month</option>');
                yearSelect.insertAdjacentHTML('beforeend', '<option value="" selected>Year</option>');
            } else if (monthSelect.id.startsWith('one-time')) {
                // Add a default blank/placeholder option for One-Time selects if empty
                 if (!monthSelect.value) { // Only set placeholder if no value is present (for first-time population)
                    monthSelect.insertAdjacentHTML('beforeend', '<option value="" selected disabled>Month</option>');
                    yearSelect.insertAdjacentHTML('beforeend', '<option value="" selected disabled>Year</option>');
                }
            }


            // Populate months
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                monthSelect.appendChild(option);
            });

            // Populate years (Current Year +/- 25 years)
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 25;
            const endYear = currentYear + 25;

            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // Set current month/year as default for Loan Start Date selects only
            if (monthSelect.id.startsWith('start-')) {
                 const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
                 monthSelect.value = currentMonth;
                 yearSelect.value = currentYear;
            }

        }


        // --- Initialization ---

        window.onload = function() {
            // Populate all static date selectors (Loan Start, Custom Prepayment)
            populateMonthYearSelects(document.getElementById('start-month'), document.getElementById('start-year'));
            populateMonthYearSelects(document.getElementById('custom-payment-month'), document.getElementById('custom-payment-year'));
            
            // Populate One-Time Selects (Now done conditionally inside updatePrepaymentInputs or manually here)
            populateMonthYearSelects(document.getElementById('one-time-month-input'), document.getElementById('one-time-year-input'));

            // Populate Rate Change Selects (3 instances)
            populateMonthYearSelects(document.getElementById('rate-change-month-1'), document.getElementById('rate-change-year-1'));
            populateMonthYearSelects(document.getElementById('rate-change-month-2'), document.getElementById('rate-change-year-2'));
            populateMonthYearSelects(document.getElementById('rate-change-month-3'), document.getElementById('rate-change-year-3'));
            
            // Set the default date for Custom Prepayment to match Loan Start Month default
            document.getElementById('custom-payment-month').value = document.getElementById('start-month').value;
            document.getElementById('custom-payment-year').value = document.getElementById('start-year').value;

            // Initialize prepayment options based on default reduction selection
            updatePrepaymentOptions();
        }
        
    </script>
</body>
</html>
